<!DOCTYPE html>
<html>
<head>
</head>
<body>
    <h1> GeoRTC Client </h1>
    <input type="text" placeholder="Enter username" id="name">
    <button id="connect">Connect</button>
    <br><br>

    <div id="controls" style="display: none;">
        <div>
            <label for="peers">List of Connected Peers: </label>
            <select id="peers"></select>
        </div>
        <br><br>
        <button id="stream-data">Stream Data</button>
        <button id="send-data">Send Data</button>
        <button id="request-data">Request Data</button>
        <button id="accept-request">Accept Request</button>
    </div>
    <br>
    <div>
        <div>
            <h2>Received Requests: </h2>
            <p id="received-request"></p>
        </div>
        <div>
            <h2>Received Data From Peer: </h2>
            <p id="received-data"></p>
        </div>
        <div>
            <h2>Received Stream:</h2>
            <p id ="text"></p>
        </div>
    </div>

</body>
<script src="./node_modules/geo-rtc/build/geortcclient.js"></script>
<!-- TODO: import it dynamically-->
<!-- https://github.com/uihilab/instant-expert/blob/master/lib/components/Faq.js -->
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script>

   let geoRtcClient = null
   
   document.getElementById('connect').onclick = function() {

    if (document.getElementById('name').value.length == 0) {
        
        alert("Please, enter name to connect")

    } else {

        let clientConn = new GeoRTCClient(document.getElementById('name').value)

        clientConn.on('connect', (data) => {
            if (data.connected) {
                geoRtcClient = data.obj
                // stream data usecase
                let dataStream = geoRtcClient.getPeers()
                // null, if client is unable to use the usecase
                if (dataStream != null) {

                    dataStream.on('data', (data)=>{
                        let str = ""
                        document.getElementById("peers").innerHTML = "";
                        data.data.forEach(peer=>{
                            str += "<option value='"+peer.name+"'>" + peer.name + "</option>"
                        })
                        document.getElementById("peers").innerHTML = str;
                        document.getElementById( 'controls' ).style.display = 'block';
                    })
                }

            } else {

                console.log(data.message)
            
            }
        })



        // let requestStream = geoRtcClient.listenRequests()
        // // null, if client is unable to use the usecase
        // if (requestStream != null) {

        //     requestStream.on('data', (data)=>{
        //         let request = data.requestor + " requested: " + data.request + ", "
        //         document.getElementById("received-request").innerHTML += request;
        //     })
        // }

    }
   }

   document.getElementById('stream-data').onclick = function(){
        
        // stream data usecase
        let dataStream = geoRtcClient.streamDataRequest()
        // null, if client is unable to use the usecase
        if (dataStream != null) {
            dataStream.on('data', (data)=>{
                if (data.status == "incomplete") {
                    document.getElementById('text').innerHTML+=data.data
                }
            })
        }
   }

   
   document.getElementById('request-data').onclick = function(){
        
        let selectedPeer = document.getElementById('peers').value
        // stream data usecase
        let dataStream = geoRtcClient.requestDataFromPeer(selectedPeer, 'data')
         // null, if client is unable to use the usecase
         if (dataStream != null) {
            dataStream.on('data', (data)=>{
                let receivedData = "Peer Sent: " + data.data
                document.getElementById('received-data').innerHTML+=receivedData
            })
        }        
   }
   
   document.getElementById('accept-request').onclick = function(){
        let selectedPeer = document.getElementById('peers').value
        // stream data usecase
        geoRtcClient.connectPeer(selectedPeer)
   }
   

   document.getElementById('send-data').onclick = function(){
        if (!geoRtcClient) {

            geoRtcClient = new GeoRTCClient(document.getElementById('name').value)
        }
        let selectedPeer = document.getElementById('peers').value
        
        geoRtcClient.sendDataToPeer(selectedPeer, 'hello')
        
   }

</script>
</html>