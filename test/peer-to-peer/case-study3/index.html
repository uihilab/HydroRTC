<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer Chat</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1> Case Study 3 - P2P </h1>
    <div id="login-container">
        <h2>Enter your username:</h2>
        <input type="text" id="username" placeholder="Username">
        <button id="connect">Join Chat</button>
    </div>

    <div id="chat-container" style="display: none;">
        <div id="users-list">
            <h2>Users Online</h2>
            <ul>
            </ul>
        </div>
        <div id="messages"></div>
        <input type="file" id="fileInput">
        <button onclick="sendFile()">Send File</button>
        <textarea id="messageInput" placeholder="Type your message..."></textarea>
        <button onclick="scrollToLatestMessage()">Send</button>
    </div>

</body>
<script src="./node_modules/hydro-rtc/build/hydrortcclient.js"></script>
<script>

    let hydroRtcClient = null

    document.getElementById('connect').onclick = function () {

        if (document.getElementById('username').value.length == 0) {

            alert("Please, enter name to connect")


        } else {

            let clientConn = new HydroRTCClient(document.getElementById('username').value)

            clientConn.on('connect', (data) => {
                // on successfull connection of client
                if (data.connected) {

                    // saving client object
                    hydroRtcClient = data.obj

                    // getting list of peers from the server
                    let dataStream = hydroRtcClient.getPeers()
                    // null, if client is unable to get the peers list
                    if (dataStream != null) {

                        // on receiving peers list
                        dataStream.on('data', (data) => {
                            let userlist = document.getElementById("users-list");
                            let userlistElem = userlist.querySelector('ul');
                            userlistElem.innerHTML = '';

                            data.data.forEach(peer => {
                                const listItem = document.createElement('li')
                                listItem.textContent = peer.name
                                userlistElem.appendChild(listItem)
                            })
                            document.getElementById("chat-container").style.display = 'block';
                            document.getElementById("login-container").style.display = 'none';
                        })
                    }

                    // Listen for requests to received data requests from other peer
                    // for collaborative data exchange
                    let requestStream = hydroRtcClient.listenRequests()
                    if (requestStream != null) {
                        // on receiving request from peer
                        requestStream.on('data', (data) => {
                            let request = data.requestor + " requested: " + data.request + ", "
                            document.getElementById//("received-request").innerHTML += request;
                        })
                    }

                } else {
                    // error message
                    console.log(data.message)

                }
            })
        }
    }

    function scrollToLatestMessage() {
                        const messagesContainer = document.getElementById('messages');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
</script>

</html>